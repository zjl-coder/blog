---
markmap:
  colorFreezeLevel: 2
---
# 从url到返回请求的过程
## 浏览器请求

### URL解析

#### 定义
- 统一资源定位符（英语：Uniform Resource Locator，缩写：URL，或称统一资源定位器、定位地址、URL地址）俗称网页地址，简称网址，是因特网上标准的资源的地址，如同在网络上的门牌。

#### 格式
##### 标准格式
- [协议类型]\://[服务器地址]:[端口号]/[资源层级UNIX文件路径][文件名]?[查询]#[片段ID]

##### 完整格式
- [协议类型]\://[访问资源需要的凭证信息]@[服务器地址]:[端口号]/[资源层级UNIX文件路径][文件名]?[查询]#[片段ID]

##### 非必填项
- [访问凭证信息]、[端口号]、[查询]、[片段ID]

#### 为什么要解析
- 只有字母和数字[0-9a-zA-Z]、一些特殊符号"$-_.+!*'(),"[不包括双引号]、以及某些保留字，才可以不经过编码直接用于URL
- 如果key或者value中包含有=就会与URL中的=混淆，所以需要经过编码

#### 编码规则
##### 浏览器
- 不同的操作系统、不同的浏览器、不同的网页字符集，将导致完全不同的编码结果
  - utf-8 gb2312等都有可能
- 网址路径中包含汉字（由浏览器发出行为）
  - IE8 火狐 将自动进行utf-8编码
  - 网址路径的编码，用的是utf-8编码
- 查询字符串包含汉字（由浏览器发出行为）
  - IE将"春节"转化成了一个乱码（GB2312编码）
  - Firefox 的处理方法，略有不同。同样采用GB2312编码，但是在每个字节前加上了%
  - 查询字符串的编码，用的是操作系统的默认编码
- Get方法生成的URL包含汉字（由浏览器发出行为）
  - `<meta http-equiv="Content-Type" content="text/html;charset=xxxx">`
  - GET和POST方法的编码，用的是网页的编码
- Ajax调用的URL包含汉字（由js发出行为）
  - 在Ajax调用中，IE总是采用GB2312编码（操作系统的默认编码）
  - Firefox总是采用utf-8编码

##### 统一规则
- 保证客户端只用一种编码方法向服务器发出请求
- 使用Javascript先对URL编码，然后再向服务器提交，不要给浏览器插手的机会。因为Javascript的输出总是一致的，所以就保证了服务器得到的数据是格式统一的

##### js编码函数
###### escape()
- 不能直接用于URL编码
- 真正作用是返回一个字符的Unicode编码值
- 具体规则是，除了ASCII字母、数字、标点符号"@ * _ + - . /"以外，对其他所有字符进行编码
- 最古老，已经不提倡使用了
- 对应的解码函数是unescape()
- 例如："Hello World"的escape()编码就是"Hello%20World"。因为空格的Unicode值是20（十六进制）
- escape()不对"+"编码，网页在提交表单的时候，如果有空格，则会被转化为+字符。服务器处理数据的时候，会把+号处理成空格。所以，使用的时候要小心

###### encodeURI()
- encodeURI()是Javascript中真正用来对URL编码的函数
- 它着眼于对整个URL进行编码，因此除了常见的符号以外，对其他一些在网址中有特殊含义的符号"; / ? : @ & = + $ , #"，也不进行编码。编码后，它输出符号的utf-8形式，并且在每个字节前加上%
- 不对单引号'编码
- 对应的解码函数是decodeURI()

###### encodeURIComponent()
- 与encodeURI()的区别是，它用于对URL的组成部分进行个别编码，而不用于对整个URL进行编码
- 因此，"; / ? : @ & = + $ , #"，这些在encodeURI()中不被编码的符号，在encodeURIComponent()中统统会被编码。至于具体的编码方法，两者是一样
- 对应的解码函数是decodeURIComponent()
- 推荐使用

### dns查询ip

#### dns解析
- 又叫域名解析

#### dns查询规则
- 当用户输入www.qq.com时，DNS解析有大致是个过程，如下：
  1. 浏览器先检查自身缓存中有没有被解析过的这个域名对应的ip地址，如果有，解析结束。同时域名被缓存的时间也可通过TTL属性来设置
  2. 如果浏览器缓存中没有（专业点叫还没命中），浏览器会检查操作系统缓存中有没有对应的已解析过的结果。而操作系统也有一个域名解析的过程。在windows中可通过c盘里一个叫hosts的文件来设置，如果你在这里指定了一个域名对应的ip地址，那浏览器会首先使用这个ip地址
  3. 如果至此还没有命中域名，才会真正的请求本地域名服务器（LDNS）来解析这个域名，这台服务器一般在你的城市的某个角落，距离你不会很远，并且这台服务器的性能都很好，一般都会缓存域名解析结果，大约80%的域名解析到这里就完成了
  4. 如果LDNS仍然没有命中，就直接跳到Root Server 域名服务器请求解析
  5. 根域名服务器返回给LDNS一个所查询域的主域名服务器（gTLD Server，国际顶尖域名服务器，如.com .cn .org等）地址
  6. 此时LDNS再发送请求给上一步返回的gTLD
  7. 接受请求的gTLD查找并返回这个域名对应的Name Server的地址，这个Name Server就是网站注册的域名服务器
  8. Name Server根据映射关系表找到目标ip，返回给LDNS
  9. LDNS缓存这个域名和对应的ip
  10. LDNS把解析的结果返回给用户，用户根据TTL值缓存到本地系统缓存中，域名解析过程至此结束

#### dns协议
- DNS占用53号端口，同时使用TCP和UDP协议
- DNS在区域传输的时候使用TCP协议，其他时候使用UDP协议

#### dns查询模式
##### 递归模式
- 递归查询是一种DNS 服务器的查询模式，在该模式下DNS 服务器接收到客户机请求，必须使用一个准确的查询结果回复客户机。如果DNS 服务器本地没有存储查询DNS 信息，那么该服务器会询问其他服务器，并将返回的查询结果提交给客户机

##### 迭代查询
- DNS 服务器另外一种查询方式为迭代查询，DNS 服务器会向客户机提供其他能够解析查询请求的DNS 服务器地址，当客户机发送查询请求时，DNS 服务器并不直接回复查询结果，而是告诉客户机另一台DNS 服务器地址，客户机再向这台DNS 服务器提交请求，依次循环直到返回查询的结果

#### 前端的dns优化
- 可以在html页面头部写入dns缓存地址
  ```html
  <meta http-equiv="x-dns-prefetch-control" content="on" />
  <link rel="dns-prefetch" href="http://bdimg.share.baidu.com" />
  ```
- TTL(Time-To-Live)，就是一条域名解析记录在DNS服务器中的存留时间

#### ipv4 ipv6
##### IPv6
- IPv6 地址中的 128 位为用冒号隔开的 8 个 16 位十六进制块。例如，2dfc:0:0:0:0217:cbff:fe8c:0
- IPv6 使用子网通过给定地址空间分配来调整网络规模
- IPv6 在 FF00::/8 使用集成地址空间用于多播
- IPv6 使用多播组
- IPv6 使用 :: 和 ::1 分别作为未指定地址和环回地址
- IPv6 使用全球唯一单播地址和本地地址 (FD00::/8)

##### IPv4
- IPv4 地址分为"多个类"，A 类网络代表一些庞大的网络，C 类网络代表数千小型网络，B 类网络介于二者之间
- IPv4 使用类类型地址空间用于多播 (224.0.0.0/4)
- IPv4 使用"广播"地址，强制每个设备停止并查看数据包
- IPv4 使用 0.0.0.0 作为未指定地址，使用类类型地址 (127.0.0.1) 作为环回地址
- IPv4 使用全球唯一公共流量地址和"私有"地址

### 协议

#### http
##### 简介
- HTTP协议是Hyper Text Transfer Protocol（超文本传输协议）的缩写,是用于从万维网（WWW:World Wide Web ）服务器传输超文本到本地浏览器的传送协议
- HTTP是一个基于TCP/IP通信协议来传递数据（HTML 文件, 图片文件, 查询结果等）

##### 原理
- HTTP协议工作于客户端-服务端架构上。浏览器作为HTTP客户端通过URL向HTTP服务端即WEB服务器发送所有请求
- Apache服务器，IIS服务器，nginx服务器等

##### HTTP三点注意事项
- HTTP是无连接：节省传输时间
- HTTP是媒体独立的：只要客户端和服务器知道如何处理的数据内容，任何类型的数据都可以通过HTTP发送
- HTTP是无状态：缺少状态意味着如果后续处理需要前面的信息，则它必须重传

##### 三次握手四次挥手建立连接

##### 通信流程
- 浏览器->http 服务器->CGI 程序->数据库

##### 消息结构
- 请求消息和响应消息

##### 版本发展
- http1.0
- http1.1
- http2.0
- http3.0

#### https
- 安全的HTTP协议

#### websocket
- 全双工通信协议

#### tcp
- 传输控制协议

#### udp
- 用户数据报协议

#### HTTP长连接和短连接 websocket
- 连接保持时间的区别

### 前端安全
- 各种前端安全问题和防护措施

### 七层网络模型 osi参考模型
- 物理层、数据链路层、网络层、传输层、会话层、表示层、应用层

## 到达服务器

## 浏览器响应

### 状态码
- HTTP响应状态码

### 响应信息头
- HTTP响应头信息

### 服务器返回html给前端

### 浏览器加载资源

#### 缓存
- 浏览器缓存机制

### cssdom + domTree = html

#### 布局和绘制
- 浏览器渲染过程

## 服务器处理

### 接收到客户端请求

### 返回html